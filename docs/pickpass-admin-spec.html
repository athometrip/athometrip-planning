
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>픽패스 어드민 기술 사양 - 앳홈트립</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT-Variable.css');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'SUIT Variable', 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; line-height: 1.7; color: #191f28; background: linear-gradient(to bottom, #f7f9fc 0%, #ffffff 100%); min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 40px 20px 80px; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 48px 40px; border-radius: 20px; margin-bottom: 40px; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.2); }
        h1 { font-size: 2.5em; font-weight: 800; color: white; margin-bottom: 16px; letter-spacing: -1px; line-height: 1.3; }
        .description { font-size: 1.1em; color: rgba(255, 255, 255, 0.95); line-height: 1.7; letter-spacing: -0.3px; }
        .section { background: white; border-radius: 16px; padding: 40px; margin-bottom: 24px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); border: 1px solid rgba(0, 0, 0, 0.05); }
        h2 { font-size: 1.75em; font-weight: 800; color: #191f28; margin-bottom: 28px; letter-spacing: -0.8px; padding-bottom: 16px; border-bottom: 3px solid #667eea; }
        h3 { font-size: 1.35em; font-weight: 700; color: #191f28; margin-top: 32px; margin-bottom: 16px; letter-spacing: -0.5px; }
        h4 { font-size: 1.1em; font-weight: 600; color: #191f28; margin-top: 24px; margin-bottom: 12px; letter-spacing: -0.3px; }
        p, li { color: #4e5968; line-height: 1.8; margin-bottom: 10px; letter-spacing: -0.3px; }
        ul, ol { margin-left: 24px; margin-bottom: 20px; }
        code { background-color: #f0f2f5; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
        pre { background-color: #f0f2f5; padding: 1em; border-radius: 8px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 28px 0; }
        table th, table td { padding: 14px; text-align: left; border-bottom: 1px solid #e5e8eb; }
        table th { background-color: #f7f9fc; font-weight: 600; }
        .info-box { background: #f7f9fc; border-left: 4px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .changelog-item { margin-bottom: 12px; padding-left: 20px; border-left: 3px solid #667eea; }
        footer { text-align: center; padding: 40px 20px; color: #8b95a1; font-size: 0.875em; margin-top: 60px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>픽패스 어드민 기술 사양</h1>
            <p class="description">픽패스 서비스의 관리자 기능, 서버 로직, 데이터베이스, API 등 백엔드 시스템에 대한 기술 사양을 정의합니다.</p>
        </header>

        <section class="section" id="table-of-contents">
            <h2>목차</h2>
            <ol>
                <li><a href="#overview">1. 시스템 개요</a></li>
                <li><a href="#policy-mgmt">2. 픽패스 정책 관리</a></li>
                <li><a href="#order-mgmt">3. 픽패스 주문 관리</a></li>
                <li><a href="#db">4. 데이터베이스 설계</a></li>
                <li><a href="#api">5. API 명세</a></li>
                <li><a href="#ops">6. 운영 및 보안</a></li>
                <li><a href="#stack">7. 기술 스택</a></li>
                <li><a href="#changelog">8. 변경 이력</a></li>
            </ol>
        </section>

        <section class="section">
            <h2 id="overview">1. 시스템 개요</h2>
            <h3 id="overview-goal">1.1. 프로젝트 목적</h3>
            <ul>
                <li><strong>운영 효율성:</strong> 도시별 픽패스 정책(가격/픽 수/옵션) 관리 및 픽패스 주문/이용 현황 운영을 위한 효율적인 관리자 페이지를 제공합니다.</li>
                <li><strong>정책 유연성:</strong> 변화하는 비즈니스 요구사항에 맞춰 픽패스 정책을 유연하게 수정하고 관리할 수 있는 시스템을 구축합니다.</li>
                <li><strong>데이터 기반 운영:</strong> 픽패스 판매 및 이용 현황 데이터를 통해 인사이트를 얻고, 데이터 기반의 의사결정을 지원합니다.</li>
            </ul>
            <h3 id="overview-features">1.2. 관리자 주요 기능</h3>
            <ul>
                <li><strong>픽패스 정책 관리:</strong> 도시별 픽패스 정책(가격/픽 수/옵션) 관리</li>
                <li><strong>픽패스 주문 관리:</strong> 픽패스 주문/이용 현황 운영</li>
            </ul>
        </section>

        <section class="section">
            <h2 id="policy-mgmt">2. 픽패스 정책 관리</h2>
            <p>도시 단위로 픽패스의 가격, PICK 수, 옵션 등을 설정하는 기능입니다.</p>
            <h3 id="policy-mgmt-ops">2.1. 기본 동작</h3>
            <ul>
                <li>도시 선택(뉴욕/칸쿤 등)을 통해 해당 도시의 정책 편집 화면으로 진입합니다.</li>
                <li>통화는 <strong>USD($)</strong>로 자동 지정되며 수정할 수 없습니다.</li>
                <li>최소 PICK 수는 <strong>2로 고정</strong>됩니다.</li>
                <li><strong>최대 PICK 수는 도시에 따라 고정</strong>되며(예: 뉴욕 12, 칸쿤 6), 수정할 수 없습니다. 이 값에 따라 가격 테이블의 행이 동적으로 생성됩니다.</li>
                <li>[저장] 시 변경사항이 DB에 반영되고, 정책 관리 리스트 화면으로 돌아갑니다.</li>
            </ul>
            <h3 id="policy-mgmt-fields">2.2. 관리 필드</h3>
            <table>
              <thead><tr><th>필드명</th><th>타입</th><th>설명</th><th>와이어프레임 ID</th></tr></thead>
              <tbody>
                <tr><td>정책 ID</td><td>String</td><td>도시별 단일 정책 세트의 고유값. 가격 등 주요 정책 변경 시 버전업되어 새로 생성됩니다. (예: NY_PASS_001)</td><td><code>policyId</code></td></tr>
                <tr><td>최대 PICK</td><td>Number</td><td>해당 도시의 상품 구성에 따라 고정된 최대 PICK 개수. (읽기 전용)</td><td><code>maxPick</code></td></tr>
                <tr><td>Adult Premium Plus</td><td>Number</td><td>성인 프리미엄 플러스 옵션 추가 금액.</td><td><code>adultPP</code></td></tr>
                <tr><td>Child Premium Plus</td><td>Number</td><td>어린이 프리미엄 플러스 옵션 추가 금액.</td><td><code>childPP</code></td></tr>
                <tr><td>사용 시작 데드라인</td><td>Number</td><td>구매 후 사용을 시작해야 하는 마감 기한(일).</td><td><code>validity</code></td></tr>
                <tr><td>부분 환불 윈도우</td><td>Number</td><td>최초 사용일로부터 부분 환불이 가능한 기간(일).</td><td><code>partialRefund</code></td></tr>
              </tbody>
            </table>
            <h3 id="policy-mgmt-price">2.3. 가격 테이블</h3>
            <p><code>최대 PICK</code> 수에 따라 PICK 2부터 PICK N까지의 가격 및 상품 매핑 행이 동적으로 생성됩니다. 각 행은 개별 상품(예: '뉴욕 픽패스 2')과 연결됩니다.</p>
            <ul>
              <li><strong>컬럼:</strong> PICK, 매핑된 상품 ID, Adult Price $, Child Price $</li>
              <li><strong>상품 매핑:</strong> 각 PICK 수량에 해당하는 상품을 드롭다운에서 선택하여 매핑합니다. 한 번 매핑된 상품은 다른 행에서 중복 선택할 수 없습니다.</li>
              <li><strong>가격 자동 입력:</strong> 상품을 선택하면 해당 상품의 성인/어린이 가격이 자동으로 입력되며, 가격 필드는 수정할 수 없도록 잠깁니다.</li>
              <li><strong>유효성 검사:</strong> 모든 PICK 행에 상품이 매핑되어야만 저장할 수 있습니다.</li>
            </ul>
            <h3 id="policy-mgmt-ux">2.4. 화면 설계 (UX 사양)</h3>
            <div class="info-box">
                <p>아래 링크를 클릭하여 정책 관리 페이지의 인터랙티브 와이어프레임 예시를 새 탭에서 확인하세요.</p>
                <p><a href="pickpass-admin-wireframe-example.html" target="_blank"><strong>인터랙티브 와이어프레임 예시 보기 (새 탭에서 열기)</strong></a></p>
            </div>
            <h4>주요 인터랙션</h4>
            <ul>
              <li><strong>정책 로딩:</strong> 도시 선택 시, 해당 도시의 `최대 PICK` 수가 고정되고 가격 테이블이 자동으로 생성됩니다.</li>
              <li><strong>상품 선택:</strong> 가격 테이블의 특정 행에서 상품을 선택하면, 해당 상품의 가격이 자동으로 오른쪽에 표시되고 입력 필드는 비활성화됩니다.</li>
              <li><strong>중복 선택 방지:</strong> 특정 상품이 하나의 행에 매핑되면, 다른 행의 상품 드롭다운 목록에서는 해당 상품이 비활성화(disabled) 처리됩니다.</li>
              <li><strong>변경 감지 (Dirty Check):</strong> 상품 매핑, 옵션 가격 등 주요 정보가 변경되면, 저장 시 새로운 버전의 정책 ID가 부여됩니다. (예: `NY_PASS_001` → `NY_PASS_002`)</li>
              <li><strong>저장 확인:</strong> [저장] 버튼 클릭 시, 성공했다는 토스트 메시지가 화면 하단에 나타납니다.</li>
            </ul>
        </section>

        <section class="section">
            <h2 id="order-mgmt">3. 픽패스 주문 관리</h2>
            <p>사용자가 구매한 픽패스의 상세 내역과 이용 기록을 조회하고 관리하는 기능입니다.</p>
            <h3 id="order-mgmt-list">3.1. 주문 리스트</h3>
            <p>와이어프레임 예시의 '주문 리스트' 테이블에 표시되는 컬럼 정보입니다.</p>
            <table>
              <thead><tr><th>컬럼명</th><th>설명</th></tr></thead>
              <tbody>
                <tr><td>ID</td><td>개별 구매 건의 고유 ID (예: NY-20251024-xxxxxx)</td></tr>
                <tr><td>주문 ID</td><td>결제와 관련된 주문 ID</td></tr>
                <tr><td>닉네임</td><td>사용자가 부여한 픽패스 별칭</td></tr>
                <tr><td>구매자명</td><td>실제 구매자 이름</td></tr>
                <tr><td>전화번호</td><td>구매자 연락처</td></tr>
                <tr><td>이메일</td><td>구매자 이메일</td></tr>
                <tr><td>도시</td><td>픽패스가 적용되는 도시 코드 (예: NYC)</td></tr>
                <tr><td>타입</td><td>Adult / Child 구분</td></tr>
                <tr><td>프리미엄+</td><td>프리미엄 플러스 옵션 포함 여부 (Yes/No)</td></tr>
                <tr><td>사용/총</td><td>사용한 PICK 수 / 전체 PICK 수 (예: 2/5)</td></tr>
                <tr><td>유효기간</td><td>패스 만료일</td></tr>
                <tr><td>업그레이드 기한</td><td>업그레이드가 가능한 마지막 날짜</td></tr>
                <tr><td>상태</td><td>Active, PartiallyUsed, Expired, Refunded 등</td></tr>
                <tr><td>변경</td><td>다운그레이드, 업그레이드, 취소/환불 등 주요 액션 버튼 영역</td></tr>
              </tbody>
            </table>
            <h3 id="order-mgmt-detail">3.2. 주문 상세</h3>
            <p>주문 리스트에서 특정 행을 클릭했을 때 오른쪽에 표시되는 상세 정보입니다.</p>
            <ul>
              <li><strong>기본 정보:</strong> ID, 주문 ID, 구매자 정보, 패스 타입, 상태 등</li>
              <li><strong>이력 (타임라인):</strong> 구매, 업그레이드, 다운그레이드, 상품 담기 등 시간 순으로 정렬된 모든 이벤트 로그</li>
              <li><strong>상품 담기/이용 이력:</strong> 사용자가 패스에 담았거나 실제 이용한 상품 목록과 상태</li>
            </ul>
            <h3 id="order-mgmt-ux">3.3. 화면 설계 (UX 사양)</h3>
            <ul>
              <li><strong>분할 화면 (Split View):</strong> 좌측에는 주문 리스트, 우측에는 선택된 주문의 상세 정보가 표시되는 구조입니다.</li>
              <li><strong>상세 정보 로딩:</strong> 리스트의 특정 행(row)을 클릭하면, 해당 주문의 상세 정보가 우측에 비동기적으로 로드됩니다.</li>
              <li><strong>액션 버튼:</strong> 리스트의 각 행마다 주요 액션(업/다운그레이드, 환불) 버튼이 제공되며, 클릭 시 해당 주문 ID를 대상으로 액션이 실행됩니다. (예: `alert('업그레이드 진행: NY-...')`)</li>
            </ul>
        </section>

        <section class="section">
            <h2 id="db">4. 데이터베이스 설계</h2>
            <h3 id="db-master">4.1. 마스터/정책 테이블</h3>
            <pre><code>
-- 도시 정보
CREATE TABLE cities (
    city_code VARCHAR(10) PRIMARY KEY,
    city_name VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE
);

-- 픽패스 정책 마스터
CREATE TABLE pickpass_policies (
    pickpass_policy_id VARCHAR(50) PRIMARY KEY,
    city_code VARCHAR(10) REFERENCES cities(city_code),
    currency VARCHAR(3) DEFAULT 'USD',
    min_pick INT DEFAULT 2,
    max_pick INT NOT NULL,
    validity_days_from_purchase INT DEFAULT 365,
    partial_refund_window_days INT DEFAULT 30,
    status VARCHAR(20) NOT NULL, -- Draft, Active, Archived
    created_at TIMESTAMP, 
    updated_at TIMESTAMP,
    UNIQUE (city_code, status) -- 도시별 Active 정책은 1개만
);

-- 픽패스 가격 테이블
CREATE TABLE pickpass_price_tiers (
    tier_id SERIAL PRIMARY KEY,
    pickpass_policy_id VARCHAR(50) REFERENCES pickpass_policies(pickpass_policy_id),
    pick_count INT NOT NULL,
    mapped_product_id VARCHAR(255), -- 각 PICK에 매핑되는 상품 ID
    adult_price DECIMAL(18, 2),
    child_price DECIMAL(18, 2),
    adult_premium_plus_price DECIMAL(18, 2),
    child_premium_plus_price DECIMAL(18, 2),
    UNIQUE (pickpass_policy_id, pick_count)
);
            </code></pre>
            <h3 id="db-usage">4.2. 주문/이용 테이블</h3>
            <p>내용 추가 예정</p>
            <h3 id="db-consistency">4.3. 인덱스 및 일관성</h3>
            <p>내용 추가 예정</p>
            <h3 id="db-transaction">4.4. 트랜잭션 및 무결성</h3>
            <h4>정책 버전 관리</h4>
            <p>가격, 최대 PICK 수 등 주요 정책이 변경될 경우, 기존 `pickpass_policy_id`를 수정하는 대신 새로운 ID를 부여하여 새 버전을 생성합니다. (예: `incPolicyId` 함수 참고)</p>
            <ul>
              <li><strong>장점:</strong> 과거 주문 데이터가 이후의 정책 변경에 영향을 받지 않도록 하여 데이터 정합성을 보장합니다. (모든 주문은 구매 시점의 정책 ID를 스냅샷으로 가집니다.)</li>
            </ul>
            <h4>상태 전이 규칙</h4>
            <p>내용 추가 예정</p>
        </section>

        <section class="section">
            <h2 id="api">5. API 명세</h2>
            <h3 id="api-policy">5.1. 정책 관리 API</h3>
            <table>
                <thead><tr><th>메서드</th><th>엔드포인트</th><th>설명</th></tr></thead>
                <tbody>
                    <tr><td>GET</td><td>/api/admin/pickpass/policies/{city_code}</td><td>특정 도시 정책 상세 조회 (도시 선택 시 호출)</td></tr>
                    <tr><td>PUT</td><td>/api/admin/pickpass/policies/{policy_id}</td><td>정책 수정 (저장 버튼 클릭 시 호출)</td></tr>
                </tbody>
            </table>
            <h3 id="api-order">5.2. 주문 관리 API</h3>
            <table>
              <thead><tr><th>메서드</th><th>엔드포인트</th><th>설명</th></tr></thead>
              <tbody>
                  <tr><td>GET</td><td>/api/admin/pickpass/orders</td><td>주문 리스트 조회 (페이지 로딩 및 필터링 시 호출)</td></tr>
                  <tr><td>GET</td><td>/api/admin/pickpass/orders/{pickpass_id}</td><td>특정 주문 상세 조회 (리스트 행 클릭 시 호출)</td></tr>
                  <tr><td>POST</td><td>/api/admin/pickpass/orders/{pickpass_id}/upgrade</td><td>업그레이드 실행</td></tr>
                  <tr><td>POST</td><td>/api/admin/pickpass/orders/{pickpass_id}/downgrade</td><td>다운그레이드 실행</td></tr>
                  <tr><td>POST</td><td>/api/admin/pickpass/orders/{pickpass_id}/refund</td><td>환불 처리</td></tr>
              </tbody>
          </table>
            <h3 id="api-example">5.3. 공통 구조 예시 (주문 상세)</h3>
            <p>내용 추가 예정</p>
        </section>

        <section class="section">
            <h2 id="ops">6. 운영 및 보안</h2>
            <h3 id="ops-rules">6.1. 운영 규칙 및 엣지케이스</h3>
            <ul>
              <li><strong>max_pick 축소 시:</strong> 현재 로직 상 사용자가 직접 `max_pick`을 수정할 수 없으므로 해당 케이스는 발생하지 않습니다. 도시별 상품 구성이 변경될 경우, 새로운 정책을 생성해야 합니다.</li>
            </ul>
            <h3 id="ops-security">6.2. 권한 및 보안 정책</h3>
            <p>내용 추가 예정</p>
            <h3 id="ops-formula">6.3. 금액 계산 공식</h3>
            <h4>업그레이드(Upgrade)</h4>
            <p>추가 결제 금액 = (상위 PICK 가격) – (하위 PICK 가격)</p>
            <h4>다운그레이드(Downgrade)</h4>
            <p>환불 금액 = (상위 PICK 가격 – 하위 PICK 가격) - $1 (수수료)</p>
            <div class="info-box"><p><strong>참고:</strong> 모든 금액 계산은 주문이 이루어진 시점의 정책(스냅샷)에 명시된 가격을 기준으로 해야 합니다.</p></div>
        </section>

        <section class="section">
            <h2 id="stack">7. 기술 스택</h2>
            <p>내용 추가 예정</p>
        </section>

        <section class="section">
            <h2 id="changelog">8. 변경 이력</h2>
            <div class="changelog-item">
                <p><strong>v1.3</strong> (2025-10-22 11:00 KST)</p>
                <ul>
                    <li>도시별 `maxPick` 값 고정 및 읽기 전용 처리</li>
                    <li>상품 선택 시 가격 자동 입력 및 중복 선택 방지 등 UX 개선사항 명세에 반영</li>
                </ul>
            </div>
            <div class="changelog-item">
                <p><strong>v1.2</strong> (2025-10-22 10:30 KST)</p>
                <ul>
                    <li>가격 테이블에 '매핑된 상품 ID' 개념 도입 및 관련 명세 수정</li>
                    <li>DB `pickpass_price_tiers` 테이블에 `mapped_product_id` 컬럼 추가</li>
                </ul>
            </div>
            <div class="changelog-item">
                <p><strong>v1.1</strong> (2025-10-15 15:00 KST)</p>
                <ul>
                    <li>와이어프레임 예시 분석을 통해 정책 및 주문 관리 섹션 내용 구체화</li>
                    <li>관리 필드, 가격 테이블, 화면 설계(UX) 등 세부 항목 추가</li>
                    <li>정책 버전 관리에 대한 내용 보강</li>
                </ul>
            </div>
            <div class="changelog-item">
                <p><strong>v1.0</strong> (2025-10-15 14:30 KST)</p>
                <ul>
                    <li>어드민 기술 사양 문서 최초 생성</li>
                    <li>원본 기획안을 바탕으로 목차 구조화 및 내용 재구성</li>
                </ul>
            </div>
        </section>

        <footer>
            <p>© 2025 Athome Trip. All rights reserved.</p>
        </footer>
    </div>
</body>
</html>
